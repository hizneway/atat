

- debug:
    msg: "{{ lookup('to_hcl', tf_base_dir+'/'+az_environment+'/'+app_tf_vars_file_name )  | to_nice_json}}"


- name: set var values fact
  set_fact:
    vars_vals: "{{ lookup('to_hcl', tf_base_dir+'/'+az_environment+'/'+app_tf_vars_file_name ) | safe | string }}"




- name: get var values
  debug:
    msg:  "{{ vars_vals }}"

- name: store in tfvars keyvault
  vars:
  azure_rm_keyvaultsecret:
    client_id: "{{ subscription_cid }}"
    tenant: "{{vault_tenant}}"
    secret: "{{subscription_secret}}"
    subscription_id: "{{ vault_subscription_id}}"
    secret_name:  "tf-{{ deploy_tag | regex_replace('\\.','-') }}"
    secret_value: '{{ vars_vals }}'
    tags:
      atat_deploy_version: "{{ deploy_tag }}"
    keyvault_uri: "{{vault_url}}"


- name: store in outputs keyvault
  vars:
  azure_rm_keyvaultsecret:
    client_id: "{{ subscription_cid }}"
    tenant: "{{vault_tenant}}"
    secret: "{{subscription_secret}}"
    subscription_id: "{{ vault_subscription_id}}"
    secret_name:  "tf-{{ deploy_tag | regex_replace('\\.','-') }}-outputs"
    secret_value: '{{ tf_app_env_outputs }}'
    tags:
      atat_deploy_version: "{{ deploy_tag }}"
    keyvault_uri: "{{vault_url}}"
  when: tf_app_env_outputs is defined
